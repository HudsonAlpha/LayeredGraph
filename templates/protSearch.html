<!doctype html>
<html>
    <head>
        <style>
            td.highlight {
                font-weight: bold;
                color: blue;
            }
            td.revhighlight {
                font-weight: bold;
                color: red;
            }
        </style>
        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
        <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
        <link href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css" rel="stylesheet"/>
        <script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
        
        <script>
            $(document).ready(function() {
                $('.hpo-select').select2({
                    minimumInputLength: 4,
                    placeholder: 'Search for gene terms...',
                    ajax: {
                        url: '/genes',
                        delay: 300,
                        dataType: 'json'
                    }
                });
                $("#table_btn").click(function () {
                    $("#resdiv").empty();
                    $("#resdiv").append("<table id=\"restable\"></table>");
                    
                    var allTerms = $(".select2").parent().find("select").val();
                    
                    columns = [
                        {title: "Rank", data: 'rank'},
                        {title: "Combined", data: 'weight'},
                        {title: "Gene", data: 'label'}
                    ];
                    
                    for (t in allTerms) {
                        columns.push({title: allTerms[t], term: allTerms[t], data: allTerms[t],
                                             mRender: function(data, type, full) {
                                                    if(type == 'display') return data[1]+" ("+data[0]+")";
                                                    else return data[1];
                                                }});
                    }
                    
                    console.log(columns);
                    
                    console.log(allTerms);
                    $.ajax({
                            type: 'POST',
                            url: '/protdeeprank',
                            data: JSON.stringify(allTerms),
                            success: function(data) {
                                $("#restable").dataTable({
                                    data: data.rankings,
                                    columns: columns,
                                    order: [[0, 'asc']],
                                    createdRow: function ( row, data, index ) {
                                        //do the combined weights
                                        if (data.weight*1 > 0) {
                                            $('td', row).eq(1).addClass('highlight');
                                        }
                                        else if (data.weight*1 < 0) {
                                            $('td', row).eq(1).addClass('revhighlight');
                                        }
                                        
                                        //loop through the HPO terms
                                        for (x=3; x < columns.length; x++) {
                                            if(data[columns[x].term][1]*1 > 0) {
                                                $('td', row).eq(x).addClass('highlight');
                                            }
                                            else if(data[columns[x].term][1]*1 < 0) {
                                                $('td', row).eq(x).addClass('revhighlight');
                                            }
                                        }
                                    }
                                });
                                
                            },
                            contentType: "application/json",
                            dataType: 'json'
                    });
                });
            });
        </script>
    </head>
    <body>
        <select name="term[]" class="hpo-select" multiple="multiple" style="width: 50%"></select><br>
        <br>
        <button id="table_btn">Table</button>
        <pre id="resdiv"></pre>
    </body>
</html>